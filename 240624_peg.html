<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ペグ</title>
    <style>
        #canvas{
            touch-action: none;
        }
    </style>
    <script src="./js/Tiny2D.js"></script>
    <script>
        var engine, ctx, timer, startTime = 0;
        var sound, score = 0, dir = Math.PI * 2;

        function rand(v){
            return Math.floor(Math.random() * v);
        }
        function init(){
            //エンジン初期化&イベントハンドラ設定
            engine = new Engine(-100, -100, 800, 800, 0, 9.8);
            var canvas = document.getElementById("canvas");
            canvas.onmousemove = mymousemove;
            canvas.onclick = myclick;
            sound = new Audio("sound.mp3");

            //左右の壁
            r = new RectangleEntity(-50, 0, 100, 500);
            r.color = "yellow";
            engine.entities.push(r);

            r = new RectangleEntity(550, 0, 100, 500);
            r.color = "yellow";
            engine.entities.push(r);

            //釘（ひとつずれた形）
            /*
            for(var i = 0; i < 9; i++){
                for(var j = 0; j < 8 + i % 2; j++){
                    var x = (j * 50 + 125) - 25 * ( i % 2); //偶数行の時は釘の数が一つ増えるのでその分左にずらす
                    var r = new CircleEntity(x, i * 50 + 100, 5, BodyStatic);
                    r.onhit = function(me, peer){
                        if( me.color == "blue" ){
                            me.color = "red";
                            score++;
                            sound.pause();
                            sound.currentTime = 0;
                            sound.play();
                            if(score >= 76) { //釘の総数 = i * j + 偶数行の数（増えた釘の数）
                                clearInterval(timer);
                                timer = NaN;
                                repaint();
                            }
                        }
                    }
                    r.color = "blue";
                    engine.entities.push(r);
                }
            }
            */
            //釘（均等に並んだ形）
            for(var i = 0; i < 9; i++){
                for(var j = 0; j < 8 ; j++){
                    var x = j * 50 + 125;
                    var r = new CircleEntity(x, i * 50 + 100, 5, BodyStatic);
                    r.onhit = function(me, peer){
                        if( me.color == "blue" ){
                            me.color = "red";
                            score++;
                            sound.pause();
                            sound.currentTime = 0;
                            sound.play();
                            if(score >= 72) {
                                clearInterval(timer);
                                timer = NaN;
                                repaint();
                            }
                        }
                    }
                    r.color = "blue";
                    engine.entities.push(r);
                }
            }

            //その他の初期化
            ctx = canvas.getContext("2d");
            ctx.font = "20pt Arial";
            startTime = new Date();
            timer = setInterval(tick, 50);
        }

        function tick(){
            engine.step(0.01);
            repaint();
        }

        function myclick(e){//マウスクリックで発射するボールを生成
            var ball = new CircleEntity(300, 20, 10, BodyDynamic, 0.9);
            ball.velocity.x = 10 * Math.cos(dir);
            ball.velocity.y = 10 * Math.sin(dir);
            ball.color = "yellow";
            engine.entities.push(ball);
        }

        function mymousemove(e){//マウスポインターのある角度に向ける
            dir = Math.atan2(e.y, (e.x - 300));
        }

        function repaint(){
            //背景クリア
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, 600, 600);

            //発射台描画
            ctx.fillStyle = "orange";
            ctx.save();
            ctx.translate(300, 0);
            ctx.rotate(dir);
            ctx.fillRect(-20, -10, 50, 20);
            ctx.restore();

            //各図形の描画
            for(var i = 0; i < engine.entities.length; i++){
                var e = engine.entities[i];
                ctx.fillStyle = e.color;
                switch(e.shape){
                    case ShapeRectangle:
                        ctx.fillRect(e.x, e.y, e.w, e.h);
                        break;
                    case ShapeCircle:
                        ctx.beginPath();
                        ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
                        ctx.closePath();
                        ctx.fill();
                        break;
                }
            }

            //各種情報表示
            var elapsed = Math.floor((new Date().getTime() - startTime) / 1000);
            ctx.fillText("score:" + score + "/72", 240, 550);
            ctx.fillText("time:" + ('000' + elapsed).slice(-3), 40, 550);
            if(isNaN(timer)){
                ctx.fillText("CLEARED!!", 220, 300);
            }
        }
    </script>
</head>
<body onload="init()">
    <canvas id="canvas" width="600" height="600"></canvas>
</body>
</html>